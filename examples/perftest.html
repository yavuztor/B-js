<html>
<head><title>test</title>
	<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.css" rel="stylesheet" />
	<style type="text/css">
		.not-too-long { height: 10em; max-height: 10em; overflow:auto; }
		.time { font-weight: bold; font-style:italic; text-decoration: underline; background-color: #ccc; text-align: right;}
	</style>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.2.0/knockout-min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.3/angular.min.js"></script>
	<script type="text/javascript" src="B.js"></script>
	<script type="text/javascript">
		_angular();
        document.addEventListener("DOMContentLoaded", function() {
        	console.log("Starting the setups");
            _knockout();
            _bjs();
            _raw();
            console.log("Finished the setups");
        });

		function testForNTimes(ntimes) {
			var times = ntimes;
			[_knockout, _bjs, _raw, _angular].forEach(function(fn){
				fn.sum = 0;
				fn.count = 0;
			});
			function test() {
				console.log(times--);
				_buildData.last = _buildData();
				document.getElementById("run-knockout").click();
				document.getElementById("run-bjs").click();
				document.getElementById("run-raw").click();
				document.getElementById("run-angular").click();
				delete _buildData.last;
				if (times > 0) requestAnimationFrame(test);
			}
			test();
		}

		function updateTime(fn, ms) {
			fn.sum = (fn.sum) ? fn.sum + ms : ms;
			fn.count = (fn.count) ? fn.count + 1 : 1;
			return (fn.sum / fn.count).toFixed(2);
		}

        function _knockout() {
            ko.applyBindings({
                selected: ko.observable(),
                data: ko.observableArray(),
                duration: ko.observable(),

                select: function(item) {
                    this.selected(item.id);
                },

                run: function() {
                    var arr = _buildData(),
                        date = new Date();

                    this.selected(null);
                    this.data(arr);
					var ms = (new Date() - date);
                    this.duration(updateTime(_knockout, ms) + " ms");
                }
            }, document.getElementById("knockout"));

        }

        function _bjs() {
        	B.bindData({
        		selected: B.observable(),
        		data: B.observable(),
        		duration: B.observable(),
        		select: function(item) {
        			this.selected(item.id);
        		},

        		run: function() {
                    var self = this,
						arr = _buildData(),
                        date = new Date();

                    this.selected(null);
                    this.data(arr);
					var bjroot = document.getElementById("bjscontent");
					var ms = (new Date() - date);
					self.duration(updateTime(_bjs, ms) + " ms");
        		}
			});
        }

        function _raw() {
			var container = document.getElementById("raw"),
				template = document.getElementById("raw-template").innerHTML;
			document.getElementById("run-raw").onclick = function() {
                var data = _buildData(),
                    date = new Date(),
                    html = "";

                for (var i = 0; i < data.length; i++) {
                    var render = template.replace(new RegExp("\\{\\{([A-Za-z]+)\\}\\}", "g"), function(match, n) {
                    	if (n == "label") return data[i].label;
                    	return match;
                    });
                    //render = render.replace("{{className}}", "");
                    //render = render.replace("{{label}}", data[i].label);
                    html += render;
                }

                container.innerHTML = html;

				var spans = container.querySelectorAll(".test-data span");
				for (var i = 0; i < spans.length; i++) {
					spans[i].addEventListener("click", function() {
						var selected = container.querySelector(".selected");
						if (selected)
							selected.className = "";
						this.className = "selected";
					});
				}
				var ms = (new Date() - date);
				document.getElementById("run-raw-result").innerHTML = updateTime(_raw, ms) + " ms";
            };
        }

		function _angular() {
			angular.module("test", []).controller("controller", function($scope) {
				$scope.run = function() {
					var data = _buildData(),
						date = new Date();

					$scope.selected = null;
					$scope.$$postDigest(function() {
						var ms = (new Date() - date);
						document.getElementById("run-angular-result").innerHTML = updateTime(_angular, ms) + " ms";
					});

					$scope.data = data;
				};

				$scope.select = function(item) {
					$scope.selected = item.id;
				};
			});
		}

		var DATACOUNT = 1000;
        function _buildData(count) {
			if (_buildData.last) return _buildData.last;

            count = count || DATACOUNT;
            var adjectives = ["pretty", "large", "big", "small", "tall", "short", "long", "handsome", "plain", "quaint", "clean", "elegant", "easy", "angry", "crazy", "helpful", "mushy", "odd", "unsightly", "adorable", "important", "inexpensive", "cheap", "expensive", "fancy"];
            var colours = ["red", "yellow", "blue", "green", "pink", "brown", "purple", "brown", "white", "black", "orange"];
            var nouns = ["table", "chair", "house", "bbq", "desk", "car", "pony", "cookie", "sandwich", "burger", "pizza", "mouse", "keyboard"];
            var data = [];
            for (var i = 0; i < count; i++)
                data.push({id: i+1, label: adjectives[_random(adjectives.length)] + " " + colours[_random(colours.length)] + " " + nouns[_random(nouns.length)] });
            return data;
		}
		function _random(max) {
			return Math.round(Math.random()*max)%max;
		}

		function runtests(frm) {
			DATACOUNT = parseInt(frm.arrsize.value);
			if (isNaN(DATACOUNT)) return alert(frm.arrsize.parentNode.textContent + " is invalid!");
			var repeat = parseInt(frm.repeat.value);
			if (isNaN(repeat)) return alert(frm.repeat.parentNode.textContent + " is invalid!");

			// let the tests begin..
			testForNTimes(repeat);
		}
	</script>
</head>
<body ng-app="test">
 	<ul>
 		<li>Source copied from: <a href="http://chrisharrington.github.io/demos/performance/">http://chrisharrington.github.io/demos/performance/</a></li>
 		<li>Original post for the comparison: <a href="https://www.codementor.io/reactjs/tutorial/reactjs-vs-angular-js-performance-comparison-knockout">https://www.codementor.io/reactjs/tutorial/reactjs-vs-angular-js-performance-comparison-knockout</a></li>
 	</ul>

	<form onsubmit="runtests(this);return false;">
		<div class="container">
			<div class="row">
				<div class="col-md-5">
					<label>Array Size: <input name="arrsize" type="number" value="1000" /></label>
				</div>
				<div class="col-md-5">
					<label>Repeat: <input name="repeat" type="number" value="1" /></label>
				</div>
				<div class="col-md-2">
					<input type="submit" value="Start Test" />
				</div>
			</div>
		</div>
	</form>

	<div class="container">
		<div class="row">
			<div id="knockout" class="col-md-3">
				<div>
					<button id="run-knockout" data-bind="click: run">KnockoutJS</button>
					<div class="time" data-bind="text: duration"></div>
				</div>
				<div class="not-too-long" data-bind="foreach: data">
					<div class="row">
						<div class="col-md-12 test-data">
							<span data-bind="click: $root.select.bind($root, $data), text: $data.label, css: { selected: $data.id === $root.selected() }"></span>
						</div>
					</div>
				</div>
			</div>
			<div id="bjs" class="col-md-3">
				<div>
					<button id="run-bjs" data-binding="event:{click: $data.run.bind($data)}">B-js</button>
					<div class="time" data-binding="text: $data.duration()"></div>
				</div>
				<div class="not-too-long" id="bjscontent" data-binding="foreach: $data.data()">
					<div class="row">
						<div class="col-md-12 test-data">
							<span data-binding="event:{click: $parent.select.bind($parent)}, text: $data.label"> to be replaced</span>
						</div>
					</div>
				</div>
			</div>
			<div id="angular" class="col-md-3" ng-controller="controller">
				<div>
					<button id="run-angular" ng-click="run()">AngularJS</button>
					<div class="time" id="run-angular-result"></div>
				</div>
				<div class="not-too-long">
					<div ng-repeat="item in data">
						<div ng-class="{ selected: item.id === $parent.selected }" ng-click="select(item)">{{item.label}}</div>
					</div>
				</div>
			</div>
			<div id="raw-container" class="col-md-3">
				<div>
					<button id="run-raw">Regexp Replace</button>
					<div class="time" id="run-raw-result"></div>
				</div>
				<div class="not-too-long" id="raw"></div>
			</div>
		</div>
	</div>

    <script type="text/html" id="raw-template">
        <div class="row">
            <div class="col-md-12 test-data">
                <span class="{{className}}">{{label}}</span>
            </div>
        </div>
    </script>
</body>
</html>
